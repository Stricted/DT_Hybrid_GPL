<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta http-equiv='Pragma' content='no-cache'/>

        <script type="text/javascript">
            /*
             JQuery is not compatible with PSP & NDSi
             script execution will stop when the jquery import.
             we should put the following script before the jquery is imported
             */
            var hardwarePlatform = navigator.platform.toLowerCase();
            var agent = navigator.userAgent.toLowerCase();
            var isPsp = (agent.indexOf("playstation") != -1);
            var isNdsi = (agent.indexOf("nintendo dsi") != -1);
            if (isPsp || isNdsi) {
                window.location.href = "notsupported.html";
            }
        </script>

        <script type="text/javascript" src="../lib/jquery-1.7.2.min.js"></script>
        <script type="text/javascript" src="../lib/log4javascript_lite.js"></script>
        <!--script type="text/javascript" src="../js/main.js"></script-->
        <script type="text/javascript" src="../js/redirect.js"></script>

        <title></title>

        <script type="text/javascript">
            var DEFAULT_GATEWAY_IP = "192.168.1.1";
            var DEFAULT_GATEWAY_DOMAIN = new Array();
            var AJAX_HEADER = '../';
            var AJAX_TAIL = '';
            var AJAX_TIMEOUT = 30000;
            
            var MACRO_NO_SIM_CARD = '255';
            var MACRO_CPIN_FAIL = '256';
            var MACRO_PIN_READY = '257';
            var MACRO_PIN_DISABLE = '258';
            var MACRO_PIN_VALIDATE = '259';
            var MACRO_PIN_REQUIRED = '260';
            var MACRO_PUK_REQUIRED = '261';
            var MACRO_INIT_SIM_CARD = '262';
            var MACRO_CARD_LOCK_PIN_RIGNT = '253';
            var MACRO_CARD_LOCK_PIN_WRONG = '254';
			
            var GATEWAY_ExternalIPAddress = '';
            var GATEWAY_ExternalIPv6Address = '';

            var log = log4javascript.getNullLogger();
            function gotoPageWithoutHistory(url) {
                log.debug('MAIN : gotoPageWithoutHistory(' + url + ')');
                window.location.replace(url);
            }

            // internal use only
            function _recursiveXml2Object($xml) {
                if ($xml.children().size() > 0) {
                    var _obj = {};
                    $xml.children().each(function() {
                        var _childObj = ($(this).children().size() > 0) ? _recursiveXml2Object($(this)) : $(this).text();
                        if ($(this).siblings().size() > 0 && $(this).siblings().get(0).tagName == this.tagName) {
                            if (_obj[this.tagName] == null) {
                                _obj[this.tagName] = [];
                            }
                            _obj[this.tagName].push(_childObj);
                        }
                        else {
                            _obj[this.tagName] = _childObj;
                        }
                    });
                    return _obj;
                }
                else {
                    return $xml.text();
                }
            }

            // convert XML string to an Object.
            // $xml, which is an jQuery xml object.
            function xml2object($xml) {
                var obj = new Object();
                if ($xml.find('response').size() > 0) {
                    var _response = _recursiveXml2Object($xml.find('response'));
                    obj.type = 'response';
                    obj.response = _response;
                }
                else if ($xml.find('error').size() > 0) {
                    var _code = $xml.find('code').text();
                    var _message = $xml.find('message').text();
                    log.warn('MAIN : error code = ' + _code);
                    log.warn('MAIN : error msg = ' + _message);
                    obj.type = 'error';
                    obj.error = {
                        code: _code,
                        message: _message
                    };
                }
                else if ($xml.find('config').size() > 0) {
                    var _config = _recursiveXml2Object($xml.find('config'));
                    obj.type = 'config';
                    obj.config = _config;
                }
                else {
                    obj.type = 'unknown';
                }
                return obj;
            }

            function getAjaxData(urlstr, callback_func, options) {
                var myurl = AJAX_HEADER + urlstr + AJAX_TAIL;
                var isAsync = true;
                var nTimeout = AJAX_TIMEOUT;
                var errorCallback = null;
            
                if (options) {
                    if (options.sync) {
                        isAsync = (options.sync == true) ? false : true;
                    }
                    if (options.timeout) {
                        nTimeout = parseInt(options.timeout, 10);
                        if (isNaN(nTimeout)) {
                            nTimeout = AJAX_TIMEOUT;
                        }
            
                    }
                    errorCallback = options.errorCB;
                }
            
                $.ajax({
                    async: isAsync,
                    //cache: false,
                    type: 'GET',
                    timeout: nTimeout,
                    url: myurl,
                    //dataType: ($.browser.msie) ? "text" : "xml",
                    error: function(XMLHttpRequest, textStatus) {
                        try {
                            if (jQuery.isFunction(errorCallback)) {
                                errorCallback(XMLHttpRequest, textStatus);
                            }
                            log.error('MAIN : getAjaxData(' + myurl + ') error.');
                            log.error('MAIN : XMLHttpRequest.readyState = ' + XMLHttpRequest.readyState);
                            log.error('MAIN : XMLHttpRequest.status = ' + XMLHttpRequest.status);
                            log.error('MAIN : textStatus ' + textStatus);
                        }
                        catch (exception) {
                            log.error(exception);
                        }
                    },
                    success: function(data) {
                        log.debug('MAIN : getAjaxData(' + myurl + ') sucess.');
                        log.trace(data);
                        var xml;
                        if (typeof data == 'string' || typeof data == 'number') {
                            if (-1 != this.url.indexOf('/api/sdcard/sdcard')) {
                                data = sdResolveCannotParseChar(data);
                            }
                            if (!window.ActiveXObject) {
                                var parser = new DOMParser();
                                xml = parser.parseFromString(data, 'text/xml');
                            }
                            else {
                                //IE
                                xml = new ActiveXObject('Microsoft.XMLDOM');
                                xml.async = false;
                                xml.loadXML(data);
                            }
                        }
                        else {
                            xml = data;
                        }
                        if (typeof callback_func == 'function') {
                            callback_func($(xml));
                        }
                        else {
                            log.error('callback_func is undefined or not a function');
                        }
                    }
                });
            }

            function getConfigData(urlstr, callback_func, options) {
                var myurl = '../' + urlstr + '';
                //var myurl = urlstr + "";
                var isAsync = true;
                var nTimeout = AJAX_TIMEOUT;
                var errorCallback = null;

                if (options) {
                    if (options.sync) {
                        isAsync = (options.sync == true) ? false : true;
                    }
                    if (options.timeout) {
                        nTimeout = parseInt(options.timeout, 10);
                        if (isNaN(nTimeout)) {
                            nTimeout = AJAX_TIMEOUT;
                        }
                    }
                    errorCallback = options.errorCB;
                }

                $.ajax({
                    async: isAsync,
                    //cache: false,
                    type: 'GET',
                    timeout: nTimeout,
                    url: myurl,
                    //dataType: ($.browser.msie) ? "text" : "xml",
                    error: function(XMLHttpRequest, textStatus, errorThrown) {
                        try {
                            log.debug('MAIN : getConfigData(' + myurl + ') error.');
                            log.error('MAIN : XMLHttpRequest.readyState = ' + XMLHttpRequest.readyState);
                            log.error('MAIN : XMLHttpRequest.status = ' + XMLHttpRequest.status);
                            log.error('MAIN : textStatus ' + textStatus);
                            if (jQuery.isFunction(errorCallback)) {
                                errorCallback(XMLHttpRequest, textStatus);
                            }
                        }
                        catch (exception) {
                            log.error(exception);
                        }
                    },
                    success: function(data) {
                        log.debug('MAIN : getConfigData(' + myurl + ') success.');
                        log.trace(data);
                        var xml;
                        if (typeof data == 'string' || typeof data == 'number') {
                            if (!window.ActiveXObject) {
                                var parser = new DOMParser();
                                xml = parser.parseFromString(data, 'text/xml');
                            }
                            else {
                                //IE
                                xml = new ActiveXObject('Microsoft.XMLDOM');
                                xml.async = false;
                                xml.loadXML(data);
                            }
                        }
                        else {
                            xml = data;
                        }
                        if (typeof callback_func == 'function') {
                            callback_func($(xml));
                        }
                        else {
                            log.error('callback_func is undefined or not a function');
                        }
                    }
                });
            }

            function getDomain(){
                getConfigData("config/lan/config.xml", function($xml){
                    var ret = xml2object($xml);
                    if(ret.type == "config")
                    {
                        DEFAULT_GATEWAY_DOMAIN.push(ret.config.landns.hgwurl.toLowerCase());
                    }
                }, {
                   sync: true
                });
            }
           function checkipv6Address(url)
           {
              //get ipv6
              var IPv6Address = '';
              getAjaxData("api/settings/hostinfo",function($xml) 
              {
                  var ret = xml2object($xml);
                  if(ret.type == "response" && typeof(ret.response.HostIPv6Address)!='undefined') 
                  {
                     IPv6Address = ret.response.HostIPv6Address;
                  }
              }, {
                 sync : true
              });
              //fd00:1020:3040:5000::1/64,fe80::1/64
              if(IPv6Address!='')
              {
                 var IPv6AddressParts = IPv6Address.split(',');
                 var i = 0;
                 for(i=0;i<IPv6AddressParts.length;i++)
                 {
                      var matchString = IPv6AddressParts[i].substring(0, IPv6AddressParts[i].lastIndexOf("/"));
                      if(url.indexOf(matchString) != -1)
                      {
                          return true;
                      }
                 }
               }             
               return false;
            }
            function isNormalLogin(gatewayAddr)
            {
                var url1 = "http://" +gatewayAddr+"/"+"index.html";
                var url2 = "http://" +gatewayAddr+"/";
                var url3 = "http://" +gatewayAddr+"/"+"indexs.html";
                var url4 = "http://" + gatewayAddr;
                var url5 = "http://" + "setup.com" + "/"+"index.html";
                var url6 = "http://" + "setup.com" + "/";
                var url7 = "http://" + "setup.com" + "/"+"index.html";
                var url8 = "http://" + "setup.com";
                var url9 = "https://" +gatewayAddr+":443/"+"index.html";
                var url10 = "https://" +gatewayAddr+":443/";
                var url11 = "https://" +gatewayAddr+":443/"+"index.html";
                var url12 = "https://" + gatewayAddr + ":443";
                var url13 = "https://" + "setup.com" + ":443/"+"index.html";
                var url14 = "https://" + "setup.com" + ":443/";
                var url15 = "https://" + "setup.com" + ":443/"+"index.html";
                var url16 = "https://" + "setup.com:443";
                var url17 = "http://[fe80::1]";
                var url18 = "http://[fe80::1]"+"/"+"index.html";
                var url19 = "http://[fe80::1]"+"/"+"indexs.html";
                var url20 = "http://[fe80::1]"+"/";
				
                var url21 = "http://" +GATEWAY_ExternalIPAddress+"/"+"index.html";
                var url22 = "http://" +GATEWAY_ExternalIPAddress+"/";
                var url23 = "http://" +GATEWAY_ExternalIPAddress+"/"+"indexs.html";
                var url24 = "http://" +GATEWAY_ExternalIPAddress;
				
                var url25 = "https://" +GATEWAY_ExternalIPAddress+"/"+"index.html";
                var url26 = "https://" +GATEWAY_ExternalIPAddress+"/";
                var url27 = "https://" +GATEWAY_ExternalIPAddress+"/"+"indexs.html";
                var url28 = "https://" +GATEWAY_ExternalIPAddress;
				
                var url29 = "https://" +gatewayAddr+"/"+"index.html";
                var url30 = "https://" +gatewayAddr+"/";
                var url31 = "https://" +gatewayAddr+"/"+"indexs.html";
                var url32 = "https://" + gatewayAddr;

                var url33 = "https://[" +GATEWAY_ExternalIPv6Address+"]/"+"index.html";
                var url34 = "https://[" +GATEWAY_ExternalIPv6Address+"]/";
                var url35 = "https://[" +GATEWAY_ExternalIPv6Address+"]/"+"indexs.html";
                var url36 = "https://[" +GATEWAY_ExternalIPv6Address+"]";

                var url37 = "https://" + "setup.com";
                var url38 = "https://" + "setup.com"+"/";

                var url =  window.location.href;
                // should be improved with the indexOf
                if( url == url1 || url == url2 || url == url3 || url == url4 
                    || url == url5 || url == url6 || url == url7 || url == url8 
                    || url == url9 || url == url10 || url == url11 || url == url12
                    || url == url13 || url == url14 || url == url15 || url == url16
                    || url == url17 || url == url18 || url == url19 || url == url20
                    || url == url21 || url == url22 || url == url23 || url == url24
                    || url == url25 || url == url26 || url == url27 || url == url28
                    || url == url29 || url == url30 || url == url31 || url == url32
                    || url == url33 || url == url34 || url == url35 || url == url36
                    || url == url37 || url == url38
                    || checkipv6Address(url)
                    || url.indexOf("127.0.0.1") != -1
                  )
                {
                    return true;
                }
                else
                {
                    return false;
                }
            
            }

            function isHandheldBrowser() {
                var bRet = false;

                var hardwarePlatform = navigator.platform.toLowerCase();
                var agent = navigator.userAgent.toLowerCase();

                var isIpod = hardwarePlatform.indexOf("iPod") != -1;
                var isIphone = hardwarePlatform.indexOf("iPhone") != -1;
                var isIpad =  hardwarePlatform.indexOf("iPad") != -1;
                var isAndroid = agent.indexOf("android") !=-1;

                log.debug("INDEX : hardwarePlatform = " + hardwarePlatform);
                log.debug("INDEX : agent = " + agent);

                if (isIphone || isIpod) {
                    log.debug("INDEX : current browser is iphone or ipod.");
                    bRet = true;
                }
                else if (isPsp) {
                    log.debug("INDEX : current browser is psp.");
                    bRet = true;
                }
                else if (isAndroid) {
                    log.debug("INDEX : current browser is android.");
                    bRet = true;
                }
                else {
                    log.debug("INDEX : screen.height = " + screen.height);
                    log.debug("INDEX : screen.width = " + screen.width);
                    if (screen.height <= 320 || screen.width <= 320) {
                        bRet = true;
                        log.debug("INDEX : current browser screen size is small.");
                    }
                }
                log.debug("INDEX : isHandheldBrowser = " + bRet);
                return bRet;
            }

            var gatewayAddr = "";
            // get current settings gateway address
            getAjaxData("api/dhcp/settings", function($xml) {
                var ret = xml2object($xml);
                if ("response" == ret.type) {
                    gatewayAddr = ret.response.DhcpIPAddress;
                }
            }, {
                sync : true
            }
            );
            //get wan ip
            getAjaxData('api/connection/wanstatus', function($xml) {
            var ret=xml2object($xml);
            if(ret.type=='response' && typeof(ret.response.ExternalIPAddress)!='undefined'
               && typeof(ret.response.X_IPv6Address)!='undefined')
            {
               GATEWAY_ExternalIPAddress = ret.response.ExternalIPAddress;
               GATEWAY_ExternalIPv6Address = ret.response.X_IPv6Address;
               if(GATEWAY_ExternalIPv6Address.indexOf("/")!=-1)
               {
                    GATEWAY_ExternalIPv6Address = GATEWAY_ExternalIPv6Address.substring(0, GATEWAY_ExternalIPv6Address.indexOf("/"));
               }
            }
            }, {
                sync : true
            }
            );
            if ("" == gatewayAddr) {
                gatewayAddr = DEFAULT_GATEWAY_IP;
            }

            var href = "http://" + DEFAULT_GATEWAY_IP;
            try {
                href = window.location.href;
            }
            catch(exception) {
                href = "http://" + DEFAULT_GATEWAY_IP;
            }
            //get connection type
            var b_onlyWan = false;
            getAjaxData("api/connection/connection",function($xml) {
                var ret = xml2object($xml);
                if(ret.type == "response" && typeof(ret.response.ConnectionDevice)!='undefined') 
                {         
                    if(ret.response.ConnectionDevice=='2')
                    {
                        b_onlyWan = true;
                    } 
                }
            }, {
                sync : true
            });  

            //get islanip
            var b_onlyWanip = false;
            getAjaxData("api/security/checkislanip",function($xml) {
                var ret = xml2object($xml);
                if(ret.type == "response" && typeof(ret.response.islanip)!='undefined') 
                {         
                    if(ret.response.islanip=='0')
                    {
                        b_onlyWanip = true;
                    } 
                }
            }, {
                sync : true
            });  
            // get incoming url from querystring
            var incoming_url = href.substring(href.indexOf("?url=") + 5);
            // truncate http://
            if (incoming_url.indexOf("//") > -1) {
                incoming_url = incoming_url.substring(incoming_url.indexOf("//") + 2);
            }
            //get *.html
            var incoming_html = "";
            if (incoming_url.indexOf(".html") > -1) {
                incoming_html = incoming_url.substring(incoming_url.lastIndexOf("/") + 1, incoming_url.length);
            }
            // truncate tail
            if (incoming_url.indexOf("/") !=  -1) {
                incoming_url = incoming_url.substring(0, incoming_url.indexOf("/"));
            }

            incoming_url = incoming_url.toLowerCase();
            // var prefix = "http://" + gatewayAddr;
            var g_indexIncomingUrlIsGateway = false;
            // if incoming url == 192.168.1.1 or MobileWifi.home then goto login
            if(isNormalLogin(gatewayAddr) || b_onlyWanip)
            {                  
                if(!b_onlyWan)
                {
                    g_indexIncomingUrlIsGateway = redirectOnCondition();
                }
            }
            else
            {
                g_indexIncomingUrlIsGateway = redirectOnConditionforindex(gatewayAddr);
            }

            $( function() {
                getDomain();
                if (g_indexIncomingUrlIsGateway) {
                    return;
                }
                else {
                    gotoPageWithoutHistory("login.html");
                }
            });
        </script>
    </head>

    <body style="background-color: #FFFFFF;">
        <noscript>
            Sorry, your browser does not support javascript.
        </noscript>
    </body>
</html>
